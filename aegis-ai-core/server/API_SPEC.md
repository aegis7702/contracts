# Aegis PoC API Spec (v0.1)

Base URL (local):
- `http://127.0.0.1:8000`

All endpoints are JSON over HTTP.

## Common Types

### `AuditResult`

```json
{
  "label": "SAFE",
  "confidence": 0.82,
  "name": "Precheck@0x...",
  "summary": "1 line summary",
  "description": "2-3 lines\\nuse \\n for line breaks\\n...",
  "reasons": ["reason 1", "reason 2"],
  "matched_patterns": ["optional", "strings"]
}
```

Notes:
- `label` is always `"SAFE"` or `"UNSAFE"`.
- `reasonsText` fields are produced by the backend by joining `reasons[]` with `\\n` (not generated by the LLM).

## Endpoints

### `GET /v1/health`

Response:

```json
{ "ok": true }
```

### `POST /v1/tx/precheck`

7702 지갑이 트랜잭션을 보내기 전에 호출하는 "사전 차단" 분석 API.

Request:

```json
{
  "chainId": 31337,
  "from": "0xYourWallet",
  "to": "0xYourWallet",
  "value": "0",
  "data": "0x...",
  "txType": 4,
  "authorizationList": []
}
```

Response:

```json
{
  "chainId": 31337,
  "allow": true,
  "audit": { "label": "SAFE", "confidence": 0.7, "name": "...", "summary": "...", "description": "...", "reasons": ["..."], "matched_patterns": [] },
  "reasonsText": "reason1\\nreason2",
  "walletCurrentImpl": "0xImpl",
  "walletCurrentImplRecord": {
    "implAddress": "0xImpl",
    "verdict": 1,
    "name": "...",
    "summary": "...",
    "description": "...",
    "reasons": "...",
    "updatedAt": 1730000000,
    "codehash": "0x..."
  }
}
```

### `POST /v1/impl/scan`

impl 주소를 받아 `eth_getCode`(runtime bytecode) 기반으로 분석하고,
결과를 `ImplSafetyRegistry.setRecordCurrent(...)`로 온체인 기록.

Request:

```json
{
  "chainId": 31337,
  "implAddress": "0xImpl"
}
```

Response:

```json
{
  "chainId": 31337,
  "implAddress": "0xImpl",
  "audit": { "label": "UNSAFE", "confidence": 0.9, "name": "...", "summary": "...", "description": "...", "reasons": ["..."], "matched_patterns": [] },
  "reasonsText": "reason1\\nreason2",
  "registryTxHash": "0x..."
}
```

### `POST /v1/impl/audit-apply`

impl 신규 등록/교체 시 감사.

- `mode=init`: 새 impl을 감사하고, 허용되면 지갑 self-call용 `aegis_init(...)` tx template 반환
- `mode=swap`: 새 impl 감사는 항상 기록하며, 추가로 "swap 호환성" 감사도 별도 온체인 기록.
  - swap mode에서는 (newImpl 단독 기록 1회) + (swap 호환성 기록 1회)로 **최대 2번 기록**이 발생할 수 있음.

Request:

```json
{
  "chainId": 31337,
  "wallet": "0xYourWallet",
  "newImplAddress": "0xNewImpl",
  "mode": "swap"
}
```

Response:

```json
{
  "chainId": 31337,
  "wallet": "0xYourWallet",
  "mode": "swap",
  "currentImpl": "0xCurrentImpl",
  "newImpl": "0xNewImpl",
  "newImplAudit": { "label": "SAFE", "confidence": 0.8, "name": "...", "summary": "...", "description": "...", "reasons": ["..."], "matched_patterns": [] },
  "newImplReasonsText": "reason1\\nreason2",
  "newImplRegistryTxHash": "0x...",
  "swapAudit": { "label": "SAFE", "confidence": 0.7, "name": "...", "summary": "...", "description": "...", "reasons": ["..."], "matched_patterns": [] },
  "swapReasonsText": "reason1\\nreason2",
  "swapRegistryTxHash": "0x...",
  "allow": true,
  "txTemplate": { "to": "0xYourWallet", "data": "0x...", "value": "0x0" }
}
```

Notes:
- 백엔드는 지갑의 private key를 보유하지 않기 때문에, 실제 `aegis_init/aegis_setImplementation` 실행은 클라이언트가 `txTemplate`로 직접 전송해야 합니다.

### `POST /v1/wallet/watch`

사후감사(worker) 모니터링 지갑 등록.

Notes:
- worker는 기본적으로 모든 새 tx에 대해 TxNote를 온체인에 기록합니다.
- worker freeze 정책:
  - worker는 **LLM postaudit 결과(label)** 로만 freeze 여부를 결정합니다.
  - postaudit 프롬프트에서 `receipt.status == 0x0`(revert/failure) 인 경우 label="SAFE" 를 강제하도록 설계되어 있어,
    정상적으로는 revert tx로 인해 freeze 되지 않습니다. (TxNote는 기록)

Request:

```json
{
  "chainId": 31337,
  "wallet": "0xYourWallet"
}
```

Response:

```json
{
  "wallet": "0xYourWallet",
  "startBlock": 123456,
  "addedAt": "2026-02-07T00:00:00+00:00"
}
```

### `GET /v1/wallet/watch?chainId=...`

Response:

```json
{
  "chainId": 31337,
  "items": [
    { "wallet": "0x...", "startBlock": 123, "addedAt": "..." }
  ]
}
```

### `DELETE /v1/wallet/watch?chainId=...&wallet=...`

Response:

```json
{ "removed": true }
```

### `GET /v1/wallet/{wallet}/tx/{txHash}?chainId=...`

온체인에 기록된 TxNote 조회.

Response:

```json
{
  "wallet": "0xYourWallet",
  "txHash": "0x...",
  "note": {
    "name": "...",
    "summary": "...",
    "description": "...",
    "reasons": "reason1\\nreason2",
    "updated_at": 1730000000
  }
}
```
